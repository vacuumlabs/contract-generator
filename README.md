
# contract-generator

Automatic contract generation based on templates.

Templates are stored in a separate [Github repository](https://github.com/vacuumlabs/contracts).

## Usage

Accessing URL of the form
```
https://[host]/contract/[name]/[date]?arg1=val1&arg2=val2&...
```
creates a contract based on AsciiDoc template `[name].adoc` and variables generated by `[name].js` using EMS data as of `[date]` in the format `YYYY-MM-DD`. For example,
```
https://contract.vacuumlabs.com/contract/IT_SZCO_Combi/2020-07-01?id=[name.surname]&signing_date=31.08.2020
```

creates a contract based on `IT_SZCO_Combi.adoc` and `IT_SZCO_Combi.js` for Jira ID `[name.surname]` using EMS data as of July 1, 2020. Every query has 2 required arguments:

- **id**: Jira ID or a list of comma separated Jira IDs. Single ID returns a PDF, list of IDs returns a ZIP containing all contracts in PDF

- **signing_date**: signing date can be in any format, this is exactly how it is formatted in the output contract

These can be followed by any number of optional arguments, which are then passed as arguments to the template function.

Replace `contract` with `contractPandadoc` to automatically email the generated contracts to the management to sign it via [Pandadoc](https://www.pandadoc.com/electronic-signature-software/). 
```
https://[host]/contractPandadoc/[name]/[date]?arg1=val1&arg2=val2&...
```

## Setup

At the moment, it is not possible to run the project locally. Instead, create preview deployments on Vercel to see any changes. 

 1. Ask project owner to get credentials to Vercel and go to [Vercel project overview](https://vercel.com/vacuumlabs/contract-generator).
 2. Run `yarn global add vercel` from command line to [install Vercel CLI](https://vercel.com/download). See [Vercel CLI reference](https://vercel.com/docs/cli#commands/overview).
 3. Run `vercel login` and use the same credentials as for the web app to login to Vercel CLI.
 4. Run `vercel switch vacuumlabs` to switch your team to Vacuumlabs.

Run `vercel` from project directory to create a preview deployment. After the build is ready, access the latest preview deployment using `contract-generator-vlnow.vacuumlabs1.vercel.app`  as a host. Inspect the deployment and view console logs using the link returned by Vercel CLI.

 

## Under the Hood

The JavaScript file `[name].js` contains single function with the signature:

```js
function({signing_date}, person) => ({
'asciidoc-var1': value1,
'asciidoc-var2': value2,
...
})
```

## Google Sheets Integration

Some templates use data from one or more Google Sheets. Spreadsheet, sheet ID and range are specified in the template function. The first row of the range is a **compulsory header**, where column names are used to index the object returned from `loadSheetData` and to join on EMS data. 

The template function in `[name].js` then has the signature

```js
function({signing_date, loadSheetData}, person) => ({
'asciidoc-var1': value1,
'asciidoc-var2': value2,
...
})
```
where `loadSheetData(person, sheet)` is a callback defined in `utils/sheets.js`, `person` is EMS data of the person with a given Jira ID and `sheet` is an object with the following properties:

 - **spreadsheetId**: extract it from the spreadsheet URL `https://docs.google.com/spreadsheets/d/spreadsheetId/edit#gid=0`
 - **sheetId**: extract it from the spreadsheet URL `https://docs.google.com/spreadsheets/d/spreadsheetId/edit#gid=sheetId`
 - **range**: empty range returns the non-empty part of the sheet, otherwise use A1 notation to specify a subset of the sheet 
 - **idSheetsColumn**: name of the column in the spreadsheet used to join EMS data 
 - **idEMSField**: name of the EMS field used to join spreadsheet data

See more detailed definition of Spreadsheet ID, Sheet ID and A1 notation [here](https://developers.google.com/sheets/api/guides/concepts).

The project uses [JWT authorization](https://developers.google.com/identity/protocols/oauth2/service-account#jwt-auth)  to access Google Sheets. If the authorization is not set:

 1. Create a project in [Google Console](https://console.developers.google.com/cloud-resource-manager).
 2. In the project, allow access to [Google Sheets API](https://console.developers.google.com/apis/library).
 3. Create a [service account](https://developers.google.com/identity/protocols/oauth2/service-account#creatinganaccount) and generate an API key.
 4. Share Google Sheet with the service account (by clicking *Share* button in the Google Sheet).
 5. Convert the private API key into base64 (make sure that newlines are in the correct format).
 6. Set [environment variables](https://vercel.com/vacuumlabs/contract-generator/settings/environment-variables) GOOGLE_EMAIL to the service account email and GOOGLE_KEY to the API key in base64.

If a service account already exists and the environment variables are set, only do the step #4 (currently in use contract-generator@contracttest-1597670081537.iam.gserviceaccount.com). 
